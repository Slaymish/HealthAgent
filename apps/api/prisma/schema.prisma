generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

model User {
  id             String   @id @default(cuid())
  name           String?
  email          String?  @unique
  emailVerified  DateTime? @map("email_verified")
  image          String?
  ingestTokenHash    String   @map("ingest_token_hash")
  ingestTokenPreview String   @map("ingest_token_preview")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  targetWeightKg Float? @map("target_weight_kg")
  targetCalories Int? @map("target_calories")
  targetProteinG Float? @map("target_protein_g")
  targetFatG Float? @map("target_fat_g")
  targetCarbsG Float? @map("target_carbs_g")
  targetSleepHours Float? @map("target_sleep_hours")
  targetTrainingSessions Int? @map("target_training_sessions")
  targetFibreG Float? @map("target_fibre_g")
  insightsSystemPrompt String? @db.Text @map("insights_system_prompt")

  accounts    Account[]
  sessions    Session[]
  ingestFiles IngestFile[]
  dailyWeights DailyWeight[]
  dailyNutrition DailyNutrition[]
  sleepSessions SleepSession[]
  workouts    Workout[]
  dailyVitals DailyVitals[]
  insightsDocs InsightsDoc[]
  pipelineRuns PipelineRun[]

  @@map("users")
}

model Account {
  id                 String  @id @default(cuid())
  userId             String  @map("user_id")
  type               String
  provider           String
  providerAccountId  String  @map("provider_account_id")
  refresh_token      String? @db.Text
  access_token       String? @db.Text
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String? @db.Text
  session_state      String?
  oauth_token_secret String? @db.Text
  oauth_token        String? @db.Text

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model IngestFile {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  source      String
  checksum    String
  storageKey  String   @map("storage_key")
  receivedAt  DateTime @default(now()) @map("received_at")
  processedAt DateTime? @map("processed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, receivedAt])
  @@unique([userId, source, checksum])
  @@map("ingest_files")
}

model DailyWeight {
  userId   String   @map("user_id")
  date     DateTime
  weightKg Float    @map("weight_kg")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, date])
  @@map("daily_weight")
}

model DailyNutrition {
  userId    String   @map("user_id")
  date      DateTime
  calories  Int?
  proteinG  Float?   @map("protein_g")
  carbsG    Float?   @map("carbs_g")
  fatG      Float?   @map("fat_g")
  fibreG    Float?   @map("fibre_g")
  alcoholG  Float?   @map("alcohol_g")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, date])
  @@map("daily_nutrition")
}

model SleepSession {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  dedupeKey   String?  @map("dedupe_key")
  start       DateTime
  end         DateTime
  durationMin Int      @map("duration_min")
  quality     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, start])
  @@unique([userId, dedupeKey])
  @@map("sleep_sessions")
}

model Workout {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  sourceId    String?  @map("source_id")
  start       DateTime
  type        String
  durationMin Int      @map("duration_min")
  distanceKm  Float?   @map("distance_km")
  avgHr       Int?     @map("avg_hr")
  maxHr       Int?     @map("max_hr")
  avgPace     Float?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, start])
  @@unique([userId, sourceId])
  @@map("workouts")
}

model DailyVitals {
  userId     String   @map("user_id")
  date       DateTime
  restingHr  Int?     @map("resting_hr")
  hrv        Float?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, date])
  @@map("daily_vitals")
}

model InsightsDoc {
  id           String   @id @default(cuid())
  userId       String   @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  markdown     String
  diffFromPrev String?  @map("diff_from_prev")
  metricsPack  Json?    @map("metrics_pack")

  pipelineRunId String?     @map("pipeline_run_id")
  pipelineRun   PipelineRun? @relation(fields: [pipelineRunId], references: [id], onDelete: SetNull)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([pipelineRunId])
  @@map("insights_docs")
}

model PipelineRun {
  id         String   @id @default(cuid())
  userId     String   @map("user_id")
  createdAt  DateTime @default(now()) @map("created_at")
  metricsPack Json     @map("metrics_pack")

  processedIngestCount Int @map("processed_ingest_count")

  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  insightsDocs InsightsDoc[]

  @@index([userId, createdAt])
  @@map("pipeline_runs")
}
